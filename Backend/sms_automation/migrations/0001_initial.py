# Generated by Django 5.2.3 on 2026-01-22 14:54

import django.core.validators
import django.db.models.deletion
import django.utils.timezone
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('user_management', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='SMSAnalytics',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('date', models.DateField(db_index=True, unique=True)),
                ('total_messages', models.IntegerField(default=0)),
                ('sent_messages', models.IntegerField(default=0)),
                ('delivered_messages', models.IntegerField(default=0)),
                ('failed_messages', models.IntegerField(default=0)),
                ('pending_messages', models.IntegerField(default=0)),
                ('delivery_rate', models.DecimalField(decimal_places=2, default=0.0, max_digits=5)),
                ('avg_delivery_time_seconds', models.DecimalField(decimal_places=2, default=0.0, max_digits=10)),
                ('success_rate', models.DecimalField(decimal_places=2, default=100.0, max_digits=5)),
                ('gateway_metrics', models.JSONField(default=dict, help_text='Metrics by gateway')),
                ('total_cost', models.DecimalField(decimal_places=2, default=0.0, max_digits=10)),
                ('avg_cost_per_message', models.DecimalField(decimal_places=4, default=0.0, max_digits=8)),
                ('template_metrics', models.JSONField(default=dict, help_text='Usage by template')),
                ('client_metrics', models.JSONField(default=dict, help_text='Metrics by client segment')),
                ('peak_hour', models.IntegerField(blank=True, help_text='Hour with most messages (0-23)', null=True)),
                ('messages_at_peak', models.IntegerField(default=0)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'SMS Analytics',
                'verbose_name_plural': 'SMS Analytics',
                'ordering': ['-date'],
                'indexes': [models.Index(fields=['date'], name='sms_automat_date_bc54ac_idx')],
            },
        ),
        migrations.CreateModel(
            name='SMSGatewayConfig',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(help_text='Gateway name for identification', max_length=100, unique=True)),
                ('gateway_type', models.CharField(choices=[('africas_talking', "Africa's Talking"), ('twilio', 'Twilio'), ('smpp', 'SMPP Gateway'), ('custom', 'Custom API')], max_length=20)),
                ('is_default', models.BooleanField(default=False, help_text='Use as default gateway')),
                ('is_active', models.BooleanField(default=True)),
                ('weight', models.IntegerField(default=1, help_text='Load balancing weight (higher = more traffic)')),
                ('api_key', models.CharField(blank=True, help_text='API Key/Username', max_length=255)),
                ('api_secret', models.CharField(blank=True, help_text='API Secret/Password', max_length=255)),
                ('api_url', models.URLField(blank=True, help_text='Base API URL')),
                ('sender_id', models.CharField(blank=True, help_text='Sender ID/Short Code', max_length=20)),
                ('shortcode', models.CharField(blank=True, help_text='Shortcode for premium messages', max_length=20)),
                ('smpp_host', models.CharField(blank=True, max_length=255)),
                ('smpp_port', models.IntegerField(blank=True, default=2775, null=True)),
                ('smpp_system_id', models.CharField(blank=True, max_length=100)),
                ('smpp_password', models.CharField(blank=True, max_length=100)),
                ('smpp_system_type', models.CharField(blank=True, default='', max_length=100)),
                ('max_messages_per_minute', models.IntegerField(default=60, validators=[django.core.validators.MinValueValidator(1)])),
                ('max_messages_per_hour', models.IntegerField(default=1000, validators=[django.core.validators.MinValueValidator(1)])),
                ('max_messages_per_day', models.IntegerField(default=10000, validators=[django.core.validators.MinValueValidator(1)])),
                ('cost_per_message', models.DecimalField(decimal_places=4, default=0.0, help_text='Cost per SMS in local currency', max_digits=8)),
                ('currency', models.CharField(default='KES', max_length=3)),
                ('balance', models.DecimalField(decimal_places=2, default=0.0, max_digits=10)),
                ('last_balance_check', models.DateTimeField(blank=True, null=True)),
                ('last_used', models.DateTimeField(blank=True, null=True)),
                ('is_online', models.BooleanField(default=True)),
                ('last_online_check', models.DateTimeField(blank=True, null=True)),
                ('total_messages_sent', models.IntegerField(default=0)),
                ('total_messages_failed', models.IntegerField(default=0)),
                ('success_rate', models.DecimalField(decimal_places=2, default=100.0, max_digits=5)),
                ('avg_delivery_time', models.DurationField(blank=True, null=True)),
                ('config', models.JSONField(default=dict, help_text='Gateway-specific configuration')),
                ('health_check_url', models.URLField(blank=True)),
                ('delivery_report_url', models.URLField(blank=True, help_text='Webhook URL for delivery reports')),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'SMS Gateway',
                'verbose_name_plural': 'SMS Gateways',
                'ordering': ['-is_default', '-weight', 'name'],
                'indexes': [models.Index(fields=['is_active', 'is_default'], name='sms_automat_is_acti_018a73_idx'), models.Index(fields=['gateway_type', 'is_active'], name='sms_automat_gateway_4fd5f9_idx')],
            },
        ),
        migrations.CreateModel(
            name='SMSTemplate',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100, unique=True)),
                ('template_type', models.CharField(choices=[('pppoe_credentials', 'PPPoE Credentials'), ('welcome', 'Welcome Message'), ('payment_reminder', 'Payment Reminder'), ('plan_expiry', 'Plan Expiry Warning'), ('promotional', 'Promotional Message'), ('system', 'System Notification'), ('custom', 'Custom Message'), ('hotspot_welcome', 'Hotspot Welcome'), ('credentials_resend', 'Credentials Resend'), ('tier_upgrade', 'Tier Upgrade Notification'), ('commission_payout', 'Commission Payout'), ('account_suspended', 'Account Suspended'), ('account_reactivated', 'Account Reactivated'), ('data_limit_warning', 'Data Limit Warning'), ('auto_renewal_reminder', 'Auto-renewal Reminder'), ('referral_invite', 'Referral Invite'), ('birthday_greeting', 'Birthday Greeting')], max_length=30)),
                ('language', models.CharField(default='en', help_text='Language code (en, sw, etc.)', max_length=10)),
                ('subject', models.CharField(blank=True, help_text='Optional subject/header', max_length=200)),
                ('message_template', models.TextField(help_text='Template with variables. Use {{variable_name}} syntax.')),
                ('character_count', models.IntegerField(default=0, editable=False)),
                ('variables', models.JSONField(default=dict, help_text='Available variables with descriptions')),
                ('required_variables', models.JSONField(default=list, help_text='List of required variables')),
                ('is_active', models.BooleanField(default=True)),
                ('is_system', models.BooleanField(default=False, help_text='System templates cannot be deleted')),
                ('max_length', models.IntegerField(default=160, help_text='Maximum allowed characters')),
                ('allow_unicode', models.BooleanField(default=True, help_text='Allow Unicode characters')),
                ('usage_count', models.IntegerField(default=0, editable=False)),
                ('last_used', models.DateTimeField(blank=True, editable=False, null=True)),
                ('description', models.TextField(blank=True, help_text='Template description and usage notes')),
                ('category', models.CharField(blank=True, help_text='Category for grouping', max_length=50)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_sms_templates', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'SMS Template',
                'verbose_name_plural': 'SMS Templates',
                'ordering': ['template_type', 'name'],
            },
        ),
        migrations.CreateModel(
            name='SMSMessage',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('phone_number', models.CharField(db_index=True, max_length=20)),
                ('phone_formatted', models.CharField(blank=True, editable=False, max_length=20)),
                ('recipient_name', models.CharField(blank=True, max_length=100)),
                ('original_template', models.TextField(blank=True, help_text='Original template content')),
                ('message', models.TextField()),
                ('message_encoded', models.TextField(blank=True, editable=False, help_text='Base64 encoded for special characters')),
                ('character_count', models.IntegerField(default=0, editable=False)),
                ('message_parts', models.IntegerField(default=1, editable=False)),
                ('priority', models.CharField(choices=[('low', 'Low (Background)'), ('normal', 'Normal'), ('high', 'High (Important)'), ('urgent', 'Urgent (Critical)')], default='normal', max_length=10)),
                ('scheduled_for', models.DateTimeField(blank=True, db_index=True, null=True)),
                ('expires_at', models.DateTimeField(blank=True, help_text='Message expiry time', null=True)),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('queued', 'Queued for Sending'), ('sending', 'Sending to Gateway'), ('sent', 'Sent to Gateway'), ('delivered', 'Delivered to Recipient'), ('failed', 'Failed to Send'), ('cancelled', 'Cancelled'), ('expired', 'Expired'), ('rejected', 'Rejected by Gateway')], db_index=True, default='pending', max_length=10)),
                ('status_message', models.TextField(blank=True, help_text='Detailed status/error message')),
                ('status_history', models.JSONField(default=list, editable=False, help_text='Status change history')),
                ('sent_at', models.DateTimeField(blank=True, db_index=True, null=True)),
                ('delivered_at', models.DateTimeField(blank=True, null=True)),
                ('gateway_message_id', models.CharField(blank=True, db_index=True, max_length=255)),
                ('gateway_response', models.JSONField(blank=True, default=dict)),
                ('delivery_attempts', models.IntegerField(default=0, editable=False)),
                ('delivery_latency', models.DurationField(blank=True, help_text='Time from sent to delivered', null=True)),
                ('delivery_confirmations', models.JSONField(blank=True, default=list, help_text='Delivery confirmations from gateway')),
                ('cost', models.DecimalField(blank=True, decimal_places=4, max_digits=10, null=True)),
                ('currency', models.CharField(default='KES', max_length=3)),
                ('retry_count', models.IntegerField(default=0)),
                ('max_retries', models.IntegerField(default=3)),
                ('next_retry_at', models.DateTimeField(blank=True, null=True)),
                ('retry_strategy', models.JSONField(blank=True, default=dict, help_text='Retry configuration')),
                ('source', models.CharField(db_index=True, default='system', max_length=100)),
                ('source_module', models.CharField(blank=True, help_text='Module that triggered the SMS', max_length=50)),
                ('reference_id', models.CharField(blank=True, db_index=True, help_text='External reference ID', max_length=100)),
                ('correlation_id', models.UUIDField(blank=True, help_text='For grouping related messages', null=True)),
                ('context_data', models.JSONField(blank=True, default=dict, help_text='Context used for template rendering')),
                ('metadata', models.JSONField(blank=True, default=dict, help_text='Additional metadata')),
                ('created_at', models.DateTimeField(db_index=True, default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('client', models.ForeignKey(blank=True, help_text='Linked client from user management', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='sms_messages', to='user_management.clientprofile')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_sms_messages', to=settings.AUTH_USER_MODEL)),
                ('gateway', models.ForeignKey(help_text='Gateway used for sending', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='messages', to='sms_automation.smsgatewayconfig')),
                ('sent_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='sent_sms_messages', to=settings.AUTH_USER_MODEL)),
                ('template', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='messages', to='sms_automation.smstemplate')),
            ],
            options={
                'verbose_name': 'SMS Message',
                'verbose_name_plural': 'SMS Messages',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='SMSAutomationRule',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100, unique=True)),
                ('rule_type', models.CharField(choices=[('pppoe_creation', 'On PPPoE Client Creation'), ('hotspot_creation', 'On Hotspot Client Creation'), ('payment_success', 'On Payment Success'), ('payment_failed', 'On Payment Failed'), ('payment_reminder', 'Payment Reminder (Scheduled)'), ('plan_expiry', 'Plan Expiry Warning'), ('welcome', 'Welcome Message'), ('promotion', 'Promotional Campaign'), ('system_alert', 'System Alert'), ('tier_upgrade', 'On Tier Upgrade'), ('tier_downgrade', 'On Tier Downgrade'), ('commission_earned', 'On Commission Earned'), ('commission_paid', 'On Commission Paid'), ('account_suspended', 'On Account Suspension'), ('account_reactivated', 'On Account Reactivation'), ('data_limit_warning', 'Data Limit Warning'), ('auto_renewal_reminder', 'Auto-renewal Reminder'), ('birthday_greeting', 'Birthday Greeting'), ('custom_event', 'Custom Event')], max_length=30)),
                ('description', models.TextField(blank=True)),
                ('is_active', models.BooleanField(default=True)),
                ('enabled_from', models.DateTimeField(blank=True, help_text='Rule active from date', null=True)),
                ('enabled_until', models.DateTimeField(blank=True, help_text='Rule active until date', null=True)),
                ('fallback_message', models.TextField(blank=True, help_text='Fallback message if template fails')),
                ('conditions', models.JSONField(default=dict, help_text='JSON conditions for rule execution')),
                ('filters', models.JSONField(default=dict, help_text='Filters for target clients')),
                ('delay_minutes', models.IntegerField(default=0, help_text='Delay after trigger in minutes')),
                ('schedule_cron', models.CharField(blank=True, help_text='Cron expression for scheduled rules', max_length=50)),
                ('time_window_start', models.TimeField(blank=True, help_text='Start time for sending window', null=True)),
                ('time_window_end', models.TimeField(blank=True, help_text='End time for sending window', null=True)),
                ('max_messages_per_day', models.IntegerField(default=1000)),
                ('max_messages_per_client', models.IntegerField(default=10, help_text='Max messages per client per day')),
                ('cool_down_hours', models.IntegerField(default=24, help_text='Hours between messages for same client')),
                ('execution_count', models.IntegerField(default=0, editable=False)),
                ('last_executed', models.DateTimeField(blank=True, editable=False, null=True)),
                ('success_count', models.IntegerField(default=0, editable=False)),
                ('failure_count', models.IntegerField(default=0, editable=False)),
                ('priority', models.CharField(choices=[('low', 'Low (Background)'), ('normal', 'Normal'), ('high', 'High (Important)'), ('urgent', 'Urgent (Critical)')], default='normal', max_length=10)),
                ('tags', models.JSONField(blank=True, default=list, help_text='Tags for categorization')),
                ('metadata', models.JSONField(blank=True, default=dict)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_sms_rules', to=settings.AUTH_USER_MODEL)),
                ('gateway_override', models.ForeignKey(blank=True, help_text='Override default gateway', null=True, on_delete=django.db.models.deletion.SET_NULL, to='sms_automation.smsgatewayconfig')),
                ('template', models.ForeignKey(help_text='Template to use for messages', on_delete=django.db.models.deletion.CASCADE, related_name='automation_rules', to='sms_automation.smstemplate')),
            ],
            options={
                'verbose_name': 'SMS Automation Rule',
                'verbose_name_plural': 'SMS Automation Rules',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='SMSDeliveryLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('gateway_transaction_id', models.CharField(blank=True, max_length=255)),
                ('old_status', models.CharField(max_length=10)),
                ('new_status', models.CharField(max_length=10)),
                ('gateway_response', models.JSONField(blank=True, default=dict)),
                ('gateway_status_code', models.CharField(blank=True, max_length=50)),
                ('gateway_status_message', models.TextField(blank=True)),
                ('error_type', models.CharField(blank=True, help_text='Error category', max_length=50)),
                ('error_code', models.CharField(blank=True, max_length=100)),
                ('error_message', models.TextField(blank=True)),
                ('error_details', models.JSONField(blank=True, default=dict)),
                ('response_time_ms', models.IntegerField(blank=True, help_text='Gateway response time in ms', null=True)),
                ('network_latency_ms', models.IntegerField(blank=True, null=True)),
                ('cost', models.DecimalField(blank=True, decimal_places=4, max_digits=10, null=True)),
                ('currency', models.CharField(default='KES', max_length=3)),
                ('operator', models.CharField(blank=True, help_text='Mobile network operator', max_length=100)),
                ('country_code', models.CharField(blank=True, max_length=3)),
                ('event_time', models.DateTimeField(default=django.utils.timezone.now)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('gateway', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='delivery_logs', to='sms_automation.smsgatewayconfig')),
                ('message', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='delivery_logs', to='sms_automation.smsmessage')),
            ],
            options={
                'verbose_name': 'SMS Delivery Log',
                'verbose_name_plural': 'SMS Delivery Logs',
                'ordering': ['-event_time'],
                'indexes': [models.Index(fields=['message', 'event_time'], name='sms_automat_message_4732fe_idx'), models.Index(fields=['gateway', 'event_time'], name='sms_automat_gateway_82401c_idx'), models.Index(fields=['new_status', 'event_time'], name='sms_automat_new_sta_228b9f_idx'), models.Index(fields=['error_type', 'event_time'], name='sms_automat_error_t_b8dd21_idx')],
            },
        ),
        migrations.CreateModel(
            name='SMSQueue',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('priority', models.IntegerField(default=0, help_text='Higher number = higher priority')),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('processing', 'Processing'), ('completed', 'Completed'), ('failed', 'Failed')], default='pending', max_length=20)),
                ('processing_started', models.DateTimeField(blank=True, null=True)),
                ('processing_ended', models.DateTimeField(blank=True, null=True)),
                ('processing_attempts', models.IntegerField(default=0)),
                ('max_processing_attempts', models.IntegerField(default=3)),
                ('queue_position', models.IntegerField(default=0, editable=False)),
                ('queued_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('error_message', models.TextField(blank=True)),
                ('last_error_at', models.DateTimeField(blank=True, null=True)),
                ('message', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='queue_entry', to='sms_automation.smsmessage')),
            ],
            options={
                'ordering': ['-priority', 'queued_at'],
                'indexes': [models.Index(fields=['status', 'priority', 'queued_at'], name='sms_automat_status_1fd343_idx'), models.Index(fields=['message'], name='sms_automat_message_e02319_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='smstemplate',
            index=models.Index(fields=['template_type', 'is_active'], name='sms_automat_templat_c7999c_idx'),
        ),
        migrations.AddIndex(
            model_name='smstemplate',
            index=models.Index(fields=['language', 'is_active'], name='sms_automat_languag_6fec73_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='smstemplate',
            unique_together={('name', 'language')},
        ),
        migrations.AddIndex(
            model_name='smsmessage',
            index=models.Index(fields=['phone_number', 'status'], name='sms_automat_phone_n_317857_idx'),
        ),
        migrations.AddIndex(
            model_name='smsmessage',
            index=models.Index(fields=['scheduled_for', 'status'], name='sms_automat_schedul_c2b728_idx'),
        ),
        migrations.AddIndex(
            model_name='smsmessage',
            index=models.Index(fields=['status', 'priority'], name='sms_automat_status_4a2b45_idx'),
        ),
        migrations.AddIndex(
            model_name='smsmessage',
            index=models.Index(fields=['client', 'created_at'], name='sms_automat_client__da594d_idx'),
        ),
        migrations.AddIndex(
            model_name='smsmessage',
            index=models.Index(fields=['gateway_message_id'], name='sms_automat_gateway_0ffb70_idx'),
        ),
        migrations.AddIndex(
            model_name='smsmessage',
            index=models.Index(fields=['reference_id'], name='sms_automat_referen_c124b4_idx'),
        ),
        migrations.AddIndex(
            model_name='smsmessage',
            index=models.Index(fields=['correlation_id'], name='sms_automat_correla_fcac9e_idx'),
        ),
        migrations.AddIndex(
            model_name='smsmessage',
            index=models.Index(fields=['source', 'created_at'], name='sms_automat_source_430ddf_idx'),
        ),
        migrations.AddIndex(
            model_name='smsautomationrule',
            index=models.Index(fields=['rule_type', 'is_active'], name='sms_automat_rule_ty_c79639_idx'),
        ),
        migrations.AddIndex(
            model_name='smsautomationrule',
            index=models.Index(fields=['is_active', 'enabled_from', 'enabled_until'], name='sms_automat_is_acti_99d0be_idx'),
        ),
    ]
